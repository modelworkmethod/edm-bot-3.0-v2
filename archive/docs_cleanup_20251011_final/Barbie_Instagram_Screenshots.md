# üì∏ Barbie List Instagram Screenshots Feature

## **Overview**

This feature allows users to upload Instagram screenshots to their Barbie List contacts and receive AI-powered vision analysis for conversation insights and opener suggestions. The analysis is performed locally using metadata and captions only‚Äî**no external data is accessed and no image bytes are downloaded**.

---

## **What This Is**

Users can:
1. Upload 1-5 Instagram screenshots to any Barbie List contact
2. Add optional captions to provide context
3. View media count and last upload time in contact view
4. Run "Analyze IG Screenshots (beta)" to get:
   - AI-generated summary based on image dimensions and captions
   - 2-3 personalized conversation openers
   - Insight detection (travel, fitness, food, art, outdoors, social)

---

## **Data Model**

### **New Table: `barbie_instagram_media`**

```sql
CREATE TABLE barbie_instagram_media (
  id BIGSERIAL PRIMARY KEY,
  contact_id BIGINT NOT NULL REFERENCES barbie_list(id) ON DELETE CASCADE,
  uploader_user_id TEXT NOT NULL,
  message_id TEXT,                   -- Discord message ID (optional)
  attachment_url TEXT NOT NULL,      -- Discord CDN URL
  caption TEXT,                      -- Optional caption
  width INT,                         -- Image width
  height INT,                        -- Image height
  uploaded_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

### **Reused Fields on `barbie_list`**

The vision analysis results are stored in existing Instagram analysis fields:
- `ai_ig_summary` - Vision analysis summary
- `ai_ig_openers` - Array of opener suggestions
- `instagram_last_checked` - Timestamp of last analysis

---

## **How to Use**

### **1. Upload Screenshots**

```
/barbie add-media contact-id:47 image1:[attach] image2:[attach] caption:"Met at coffee shop, loves hiking"
```

**Parameters:**
- `contact-id` (required) - ID of the contact to add screenshots to
- `caption` (optional) - Caption to describe the screenshots
- `image1` through `image5` - Attachment slots for screenshots

**Response:**
```
‚úÖ Instagram Screenshots Added
Successfully added 2 screenshot(s) to Sarah

Contact ID: #47
Screenshots: 2 image(s)
Caption: Met at coffee shop, loves hiking

Use /barbie view to see the media and run analysis
```

**Validation:**
- At least 1 image required
- Maximum 5 images per upload
- Only image files accepted (jpeg, png, gif, webp)
- Captions sanitized (max 2000 chars, control characters removed)

### **2. View Contact with Media**

```
/barbie view id:47
```

**Media Teaser Display:**
```
üì∏ Instagram Screenshots
2 screenshot(s) uploaded ‚Ä¢ Latest: 5 minutes ago
```

**Buttons Available:**
- "Get Opener Suggestion" (standard)
- "Delete" (standard)
- "View Instagram" (if handle exists)
- "Analyze IG (beta)" (if handle exists)
- **"Analyze IG Screenshots (beta)"** (if media exists) üì∏

### **3. Run Vision Analysis**

Click the **"Analyze IG Screenshots (beta)"** button.

**Analysis Process:**
1. Loads up to 4 most recent screenshots
2. Extracts metadata (dimensions, captions)
3. Detects insights (travel, fitness, food, etc.)
4. Generates deterministic summary and openers
5. Stores results in contact record
6. Displays analysis embed

**Example Output:**
```
üì∏ Instagram Vision Analysis: Sarah

(Stub) Analyzed 2 screenshot(s) without external data access. 
Detected themes: travel, outdoors. Image format: portrait-focused. 
This is a deterministic local analysis without actual image processing.

üí¨ Opener Suggestions (3)
1. What's the most spontaneous trip you've ever taken?
2. There's something special about being outdoors‚Äîwhat's your favorite spot?
3. I love getting to know people beyond the surface‚Äîwhat's something you're passionate about?

üìä Analysis Details
‚Ä¢ Screenshots analyzed: 2
‚Ä¢ Insights detected: travel, outdoors, portrait-focused

Generated by local vision stub (no external data accessed)
```

---

## **Privacy Rules**

### **Private Contacts**
Contacts marked with `is_private = true` have special privacy protection:

**In Public Channels:**
- Media teaser shows: "üîí Media hidden in public channel"
- "Analyze IG Screenshots" button is **hidden**
- Analysis results are only available via ephemeral responses

**In DMs or Ephemeral Replies:**
- Full media teaser visible
- Analysis button visible
- All results displayed normally

### **Data Storage**
- Only Discord CDN URLs are stored (not image files)
- Captions are sanitized before storage
- No external API calls are made
- No image bytes are downloaded or processed

---

## **Rate Limits**

### **Vision Analysis Rate Limit**
- **Key**: `ig-vision:{userId}`
- **Limit**: 1 analysis per 60 seconds per user
- **Scope**: Per-user, across all contacts

**Throttle Message:**
```
‚è±Ô∏è Rate limited: Please wait 60 seconds before analyzing another profile.
```

---

## **API Reference**

### **BarbieListManager Methods**

```javascript
// Add Instagram media
const results = await manager.addInstagramMedia({
  contactId: 47,
  uploaderUserId: '123456789',
  messageId: 'discord_message_id',
  items: [
    {
      attachment_url: 'https://cdn.discordapp.com/attachments/...',
      caption: 'Met at coffee shop',
      width: 1080,
      height: 1920
    }
  ]
});

// Get Instagram media
const media = await manager.getInstagramMedia(contactId, 8);

// Get media count
const count = await manager.getInstagramMediaCount(contactId);

// Update vision analysis results
await manager.updateInstagramVision(contactId, userId, {
  summary: 'Analysis summary...',
  openers: ['Opener 1', 'Opener 2']
});

// Delete media
const deleted = await manager.deleteInstagramMedia(mediaId, uploaderUserId);
```

### **InstagramVisionStub Service**

```javascript
const visionAnalyzer = require('../../services/ai/InstagramVisionStub');

const analysis = await visionAnalyzer.analyze({
  media: [
    { attachment_url: 'url1', width: 1080, height: 1920 },
    { attachment_url: 'url2', width: 1080, height: 1920 }
  ],
  captions: ['Caption 1', 'Caption 2'],
  handle: 'sarah_designer'
});

// Returns:
// {
//   summary: '(Stub) Analyzed 2 screenshot(s)...',
//   openers: ['Opener 1', 'Opener 2', 'Opener 3'],
//   disclaimer: 'Generated by local vision stub (no external data accessed)',
//   lastAnalyzed: '2024-01-15T10:30:00.000Z',
//   mediaAnalyzed: 2,
//   insightsDetected: ['travel', 'outdoors', 'portrait-focused']
// }
```

### **Utility Functions**

```javascript
const { sanitizeCaption, isLikelyIGScreenshot } = require('../../utils/social');

// Sanitize caption text
const clean = sanitizeCaption(rawCaption); // Removes control chars, limits to 2000 chars

// Check if file is likely an IG screenshot
const isScreenshot = isLikelyIGScreenshot({
  fileName: 'IMG_20240115.png',
  contentType: 'image/png',
  width: 1080,
  height: 1920
}); // true
```

---

## **Test Checklist**

### **‚úÖ Exit Criteria**

- [ ] Migration 018 applies cleanly with `npm run migrate`
- [ ] `/barbie add-media` persists 1-5 image attachments + optional caption
- [ ] Viewing a contact shows "media: N items (latest: <relative time>)" teaser
- [ ] Media teaser is hidden in public channels for private contacts
- [ ] "Analyze IG Screenshots (beta)" button appears when media exists
- [ ] Analysis produces:
  - `ai_ig_summary` updated (prefixed with "(Stub) ‚Ä¶")
  - 2-3 `ai_ig_openers` suggestions stored
  - `instagram_last_checked` set to NOW()
- [ ] Rate limit enforced: 2nd analysis within 60s returns throttle message
- [ ] All responses are ephemeral in guild text if `contact.private === true`
- [ ] No external HTTP calls are made (verified by code search)
- [ ] Docs page exists with steps

### **Manual Testing Steps**

1. **Upload Media**
   ```
   /barbie add-media contact-id:1 image1:[screenshot] caption:"Test upload"
   ```
   - ‚úÖ Success message shows
   - ‚úÖ Media count increments

2. **View Contact**
   ```
   /barbie view id:1
   ```
   - ‚úÖ Media teaser appears
   - ‚úÖ "Analyze IG Screenshots (beta)" button visible
   - ‚úÖ Privacy guard works in public channels

3. **Run Analysis**
   - Click "Analyze IG Screenshots (beta)"
   - ‚úÖ Analysis embed appears with summary and openers
   - ‚úÖ Results persist to contact record
   - ‚úÖ Re-viewing contact shows updated data

4. **Rate Limiting**
   - Run analysis twice within 60 seconds
   - ‚úÖ Second attempt shows throttle message

5. **Privacy Testing**
   - Mark contact as private: `UPDATE barbie_list SET is_private = true WHERE id = 1`
   - View in public channel
   - ‚úÖ Media teaser hidden
   - ‚úÖ Analysis button hidden

---

## **Future Enhancements**

### **Phase 2 Possibilities**

1. **Real Vision AI Integration**
   - Replace stub with actual vision model (OpenAI GPT-4V, Claude Vision, etc.)
   - Analyze image content, not just metadata
   - Detect clothing style, activities, locations from actual pixels

2. **Advanced Insights**
   - Personality trait detection
   - Fashion/style analysis
   - Activity pattern recognition
   - Social circle analysis

3. **Consent & Legal**
   - Explicit user consent flow for image analysis
   - Legal compliance checks (GDPR, CCPA)
   - Watermarking and source attribution

4. **Media Management**
   - Gallery view for all screenshots
   - Bulk upload and delete
   - Media tagging and search
   - Export media archive

5. **Enhanced Openers**
   - Context-aware openers based on current events
   - Personality matching algorithm
   - Success rate tracking for openers
   - A/B testing for opener effectiveness

---

## **Technical Implementation Notes**

### **No External Calls**
The vision stub is designed to **never** make external API calls:
- ‚úÖ No image bytes downloaded
- ‚úÖ No external vision API calls
- ‚úÖ No web scraping
- ‚úÖ Only Discord CDN URLs stored (not files)
- ‚úÖ Analysis based purely on metadata and captions

### **Deterministic Results**
Given the same input (handle/URL + metadata), the stub will always produce the same output:
- Uses seed-based randomization for consistency
- Enables testing and debugging
- Prevents "analysis drift" over time

### **Performance Considerations**
- Media count queries are indexed (`idx_bim_contact`)
- Vision analysis limited to 4 most recent screenshots
- Cache implemented for repeated analyses (max 100 entries)
- Rate limiting prevents abuse

### **Backward Compatibility**
- Existing Instagram fields (`ai_ig_summary`, `ai_ig_openers`) reused
- No breaking changes to existing commands
- Migration is additive-only (no ALTER on existing columns)
- Works alongside existing Instagram handle feature

---

## **Error Handling**

### **Common Errors**

| Error | Cause | Solution |
|-------|-------|----------|
| ‚ùå Please attach at least 1 screenshot | No images attached | Attach at least one image file |
| ‚ùå Attachment N is not an image | Non-image file attached | Only attach image files (jpg, png, gif, webp) |
| ‚ùå Maximum 5 screenshots allowed | Too many images | Upload max 5 images per command |
| ‚ùå Contact not found | Invalid contact ID or no permission | Verify contact ID and ownership |
| ‚ùå No Instagram screenshots found | No media uploaded yet | Use `/barbie add-media` first |
| ‚è±Ô∏è Rate limited | Analysis called twice within 60s | Wait 60 seconds between analyses |

---

## **Security & Compliance**

### **Data Minimization**
- Only store URLs, not image files
- Captions sanitized to remove exploits
- No PII stored beyond Discord IDs

### **Access Control**
- Users can only upload to their own contacts
- Users can only analyze their own contacts
- Privacy flags enforced at display layer

### **Rate Limiting**
- Prevents spam and abuse
- Protects server resources
- User-specific throttling

### **Future GDPR Considerations**
- Data export includes media URLs
- Right to deletion cascades to media table
- Consent flow required before real vision AI

---

**‚ö†Ô∏è Important**: This is a stub implementation that generates placeholder analysis without accessing external Instagram data. All analysis is deterministic and local-only for privacy and compliance. Real vision AI integration requires explicit user consent and legal review.
